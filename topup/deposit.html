<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit - Lapak Dika</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --aksen: #4318ff; --bg: #070708; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; padding: 20px; overflow-x: hidden; }
        .container { width: 100%; max-width: 400px; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .back-btn { background: var(--card); border: 1px solid var(--border); color: white; padding: 10px 15px; border-radius: 12px; cursor: pointer; }
        .input-box { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 30px; }
        input { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 18px; border-radius: 15px; color: white; font-size: 22px; font-weight: 800; text-align: center; margin: 15px 0; outline: none; }
        .grid-nom { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .btn-nom { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-align: center; cursor: pointer; }
        .btn-bayar { width: 100%; padding: 18px; background: var(--aksen); border: none; border-radius: 18px; color: white; font-weight: 800; font-size: 16px; margin-top: 25px; cursor: pointer; }

        /* QRIS View */
        .qr-card { background: white; padding: 20px; border-radius: 30px; margin-bottom: 20px; }
        .status-box { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 25px; text-align: center; }

        /* Struk Canvas (Hidden from Screen) */
        #struk-canvas { 
            background: #ffffff; color: #1a1a1b; width: 420px; padding: 50px 40px; border-radius: 60px;
            box-sizing: border-box; position: absolute; left: -9999px;
        }
        .s-header { text-align: center; margin-bottom: 30px; }
        .s-logo-img { width: 80px; height: 80px; border-radius: 22px; object-fit: cover; margin-bottom: 15px; }
        .s-header h2 { margin: 0; font-size: 24px; font-weight: 800; color: #1e293b; }
        .s-info-cont { margin: 25px 0; }
        .s-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f8fafc; }
        .s-label { font-size: 13px; font-weight: 700; color: #94a3b8; }
        .s-val { font-size: 13px; font-weight: 800; color: #1e293b; }
        .s-divider-cont { position: relative; margin: 15px 0; display: flex; align-items: center; justify-content: center; }
        .s-line { border-top: 2.5px dashed #e2e8f0; width: 100%; }
        .s-hole { position: absolute; width: 45px; height: 45px; background: var(--bg); border-radius: 50%; top: 50%; transform: translateY(-50%); }
        .hole-l { left: -63px; } .hole-r { right: -63px; }
        .s-total-box { background: linear-gradient(135deg, #34d399, #05cd99); padding: 35px 20px; border-radius: 40px; text-align: center; color: white; }
        .status-tag { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.25); padding: 7px 16px; border-radius: 100px; font-size: 11px; font-weight: 800; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <h2 style="font-size: 18px; font-weight: 800; margin:0">Top Up Saldo</h2>
    </div>

    <div id="view-input">
        <div class="input-box">
            <label style="font-size: 11px; color:#555; font-weight:800">NOMINAL DEPOSIT</label>
            <input type="number" id="nom-input" value="10000">
            <div class="grid-nom">
                <div class="btn-nom" onclick="setN(2000)">2k</div>
                <div class="btn-nom" onclick="setN(5000)">5k</div>
                <div class="btn-nom" onclick="setN(10000)">10k</div>
                <div class="btn-nom" onclick="setN(20000)">20k</div>
                <div class="btn-nom" onclick="setN(50000)">50k</div>
                <div class="btn-nom" onclick="setN(100000)">100k</div>
            </div>
        </div>
        <button class="btn-bayar" onclick="gasDepo()">Konfirmasi Deposit</button>
    </div>

    <div id="view-qr" style="display:none;">
        <div class="qr-card" id="qr-img-cont" style="text-align:center"></div>
        <div class="status-box">
            <div style="font-size:11px; color:#888">TOTAL TAGIHAN</div>
            <div id="tagihan-display" style="font-size:28px; font-weight:800; color:var(--aksen)"></div>
            <div style="font-size:12px; color:#05CD99; font-weight:800; margin-top:10px"><i class="fas fa-sync fa-spin"></i> MENUNGGU PEMBAYARAN</div>
            <button onclick="location.reload()" style="width:100%; padding:15px; background:none; border:1px solid #ff4d4d; color:#ff4d4d; border-radius:15px; font-weight:800; margin-top:15px; cursor:pointer">BATALKAN</button>
        </div>
    </div>
</div>

<div id="struk-canvas">
    <div class="s-header">
        <img src="https://i.ibb.co.com/qLSJtrTS/20250408-111748.jpg" class="s-logo-img">
        <h2>Lapak Dika</h2>
        <p>E-Receipt â€¢ Success</p>
    </div>
    <div class="s-info-cont">
        <div class="s-row"><span class="s-label">Waktu Transaksi</span><span class="s-val" id="s-time"></span></div>
        <div class="s-row"><span class="s-label">ID Transaksi</span><span class="s-val" id="s-id"></span></div>
        <div class="s-row"><span class="s-label">Nama Akun</span><span class="s-val" id="s-email"></span></div>
        <div class="s-row" style="border:none;"><span class="s-label">Metode Bayar</span><span class="s-val">QRIS Dinamis</span></div>
    </div>
    <div class="s-divider-cont">
        <div class="s-hole hole-l"></div>
        <div class="s-line"></div>
        <div class="s-hole hole-r"></div>
    </div>
    <div class="s-total-box">
        <small>Saldo Diterima</small>
        <h1 id="s-total"></h1>
        <div class="status-tag"><i class="fas fa-check-circle"></i> Transaksi Sukses</div>
    </div>
    <div style="text-align:center; margin-top:35px;">
        <div style="font-size:14px; font-weight:800;">Terimakasih telah berkunjung di Lapak Dika</div>
        <div style="font-size:11px; color:#05cd99; font-weight:800; margin-top:5px">Kunjungi terus untuk promo otomatis</div>
    </div>
</div>

<script>
    const userMail = localStorage.getItem('userEmail');
    let poll;

    function setN(v) { document.getElementById('nom-input').value = v; }

    async function gasDepo() {
        const n = document.getElementById('nom-input').value;
        if(n < 2000) return alert("Minimal 2rb bang!");
        document.getElementById('view-input').style.display = 'none';
        document.getElementById('view-qr').style.display = 'block';
        document.getElementById('qr-img-cont').innerHTML = `<i class="fas fa-spinner fa-spin" style="color:black; font-size:30px"></i>`;

        try {
            const req = await fetch(`/api/deposit?nominal=${n}&metode=QRISFAST`);
            const d = await req.json();
            if(d.success) {
                document.getElementById('qr-img-cont').innerHTML = `<img src="${d.data.qr_image}" style="width:100%; border-radius:15px">`;
                document.getElementById('tagihan-display').innerText = `Rp ${d.data.nominal.toLocaleString()}`;
                startCheck(d.data.id);
            }
        } catch(e) { location.reload(); }
    }

    function startCheck(id) {
        poll = setInterval(async () => {
            const r = await fetch(`/api/status-deposit?id=${id}&email=${userMail}`);
            const res = await r.json();
            if(res.status === 'success') {
                clearInterval(poll);
                showSuccess(res, id);
            }
        }, 5000);
    }

    function showSuccess(res, id) {
        document.getElementById('s-time').innerText = new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
        document.getElementById('s-email').innerText = userMail;
        document.getElementById('s-id').innerText = id.toUpperCase();
        document.getElementById('s-total').innerText = `+Rp ${res.added.toLocaleString()}`;

        setTimeout(() => {
            html2canvas(document.querySelector("#struk-canvas"), { scale: 3, backgroundColor: null, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                document.body.innerHTML = `
                    <div style="text-align:center; padding:20px; width:100%; max-width:400px; margin:auto; animation: fadeIn 0.6s ease;">
                        <i class="fas fa-check-circle" style="font-size:70px; color:#05CD99; margin-bottom:20px"></i>
                        <h2 style="font-weight:800;">Top Up Berhasil!</h2>
                        <img src="${imgData}" style="width:100%; border-radius:35px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); margin: 20px 0;">
                        <button class="btn-bayar" onclick="location.href='katalog.html'">Gas Belanja</button>
                        <a href="${imgData}" download="Struk-Dika-${id}.png" style="display:block; margin-top:20px; color:#00D1FF; text-decoration:none; font-size:12px; font-weight:800;">SIMPAN KE GALERI</a>
                    </div>
                `;
            });
        }, 1000);
    }
</script>
</body>
</html>
