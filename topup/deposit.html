<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit - Lapak Dika</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --aksen: #7c4dff; 
            --bg: #0b0b0f; 
            --card: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1);
            --text-muted: #94a3b8;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: white; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
            padding: 20px; 
        }

        .container { width: 100%; max-width: 400px; }

        .header { 
            display: flex; 
            align-items: center; 
            gap: 15px;
            margin-bottom: 25px; 
        }

        .back-btn { 
            background: var(--card); 
            border: 1px solid var(--border); 
            color: white; 
            width: 40px;
            height: 40px;
            border-radius: 12px; 
            cursor: pointer;
        }

        .input-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 25px; 
            border-radius: 24px; 
            backdrop-filter: blur(10px);
        }

        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--aksen);
            font-weight: 800;
            display: block;
            margin-bottom: 15px;
        }

        .manual-input-group {
            position: relative;
            margin-bottom: 25px;
        }

        .currency-prefix {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 800;
            color: var(--text-muted);
            font-size: 18px;
        }

        input { 
            width: 100%; 
            background: rgba(0,0,0,0.3); 
            border: 2px solid var(--border); 
            padding: 18px 18px 18px 55px; 
            box-sizing: border-box;
            border-radius: 16px; 
            color: white; 
            font-size: 24px; 
            font-weight: 800; 
            outline: none; 
            transition: 0.3s;
        }

        input:focus { border-color: var(--aksen); box-shadow: 0 0 15px rgba(124, 77, 255, 0.3); }

        .grid-pilih-cepat { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
        }

        .chip-nom { 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 15px; 
            border-radius: 14px; 
            font-size: 14px; 
            font-weight: 700; 
            text-align: center; 
            cursor: pointer; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .chip-nom:hover { border-color: var(--aksen); }
        .chip-nom.active { background: var(--aksen); border-color: var(--aksen); color: white; }

        .btn-bayar { 
            width: 100%; 
            padding: 18px; 
            background: var(--aksen); 
            border: none; 
            border-radius: 18px; 
            color: white; 
            font-weight: 800; 
            font-size: 16px; 
            margin-top: 25px; 
            cursor: pointer; 
            box-shadow: 0 10px 20px rgba(124, 77, 255, 0.3);
        }

        .qr-card { background: white; padding: 20px; border-radius: 24px; margin-bottom: 20px; text-align: center; }
        .status-box { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 20px; text-align: center; }

        .fee-info-row {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 12px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        #struk-canvas { 
            background: #ffffff; color: #1a1a1b; width: 420px; padding: 50px 40px; border-radius: 60px;
            box-sizing: border-box; position: absolute; left: -9999px;
        }
        .s-header { text-align: center; margin-bottom: 30px; }
        .s-logo-img { width: 80px; height: 80px; border-radius: 22px; object-fit: cover; margin-bottom: 15px; }
        .s-header h2 { margin: 0; font-size: 24px; font-weight: 800; }
        .s-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .s-label { font-size: 14px; color: #64748b; }
        .s-val { font-size: 14px; font-weight: 800; }
        .s-total-box { background: #00b09b; padding: 30px; border-radius: 30px; text-align: center; color: white; margin: 20px 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <h2 style="font-size: 18px; font-weight: 800; margin:0">Top Up Saldo</h2>
    </div>

    <div id="view-input" style="animation: fadeIn 0.4s ease;">
        <div class="input-card">
            <span class="section-label">Input Manual</span>
            <div class="manual-input-group">
                <span class="currency-prefix">Rp</span>
                <input type="number" id="nom-input" value="10000" oninput="clearChips()">
            </div>

            <span class="section-label">Pilih Cepat</span>
            <div class="grid-pilih-cepat">
                <div class="chip-nom" onclick="setN(5000, this)">5.000</div>
                <div class="chip-nom active" onclick="setN(10000, this)">10.000</div>
                <div class="chip-nom" onclick="setN(20000, this)">20.000</div>
                <div class="chip-nom" onclick="setN(50000, this)">50.000</div>
                <div class="chip-nom" onclick="setN(100000, this)">100.000</div>
                <div class="chip-nom" onclick="setN(200000, this)">200.000</div>
            </div>
        </div>
        <button class="btn-bayar" onclick="gasDepo()">Konfirmasi Pembayaran</button>
    </div>

    <div id="view-qr" style="display:none; animation: fadeIn 0.4s ease;">
        <div class="qr-card" id="qr-img-cont"></div>
        <div class="status-box">
            <span style="font-size:11px; color:var(--text-muted)">TOTAL TAGIHAN</span>
            <div id="tagihan-display" style="font-size:28px; font-weight:800; color:white; margin:5px 0"></div>
            
            <div class="fee-info-row">
                <div>
                    <div style="font-size: 10px; color: var(--text-muted); font-weight: 700;">FEE</div>
                    <div id="fee-display" style="font-size: 14px; font-weight: 800; color: #ff4d4d;"></div>
                </div>
                <div>
                    <div style="font-size: 10px; color: var(--text-muted); font-weight: 700;">SALDO MASUK</div>
                    <div id="get-display" style="font-size: 14px; font-weight: 800; color: #4ade80;"></div>
                </div>
            </div>

            <div style="font-size:12px; color:#4ade80; font-weight:700; margin-top:10px">
                <i class="fas fa-spinner fa-spin"></i> MENUNGGU PEMBAYARAN
            </div>
            <button onclick="location.reload()" style="width:100%; padding:14px; background:none; border:1px solid #ff4d4d; color:#ff4d4d; border-radius:14px; font-weight:800; margin-top:20px; cursor:pointer">BATALKAN</button>
        </div>
    </div>
</div>

<div id="struk-canvas">
    <div class="s-header">
        <img src="https://i.ibb.co.com/qLSJtrTS/20250408-111748.jpg" class="s-logo-img">
        <h2>Lapak Dika</h2>
        <p>E-Receipt Success</p>
    </div>
    <div class="s-info-cont">
        <div class="s-row"><span class="s-label">Waktu</span><span class="s-val" id="s-time"></span></div>
        <div class="s-row"><span class="s-label">ID Transaksi</span><span class="s-val" id="s-id"></span></div>
        <div class="s-row"><span class="s-label">Akun</span><span class="s-val" id="s-email"></span></div>
        <div class="s-row"><span class="s-label">Nominal Bayar</span><span class="s-val" id="s-nominal"></span></div>
        <div class="s-row"><span class="s-label">Biaya Fee</span><span class="s-val" id="s-fee-struk" style="color:#ff4d4d"></span></div>
    </div>
    <div class="s-total-box">
        <small>Total Saldo Diterima</small>
        <h1 id="s-total" style="margin:5px 0"></h1>
        <div style="font-size:11px; font-weight:800; background:rgba(255,255,255,0.2); padding:5px 10px; border-radius:20px; display:inline-block">SUKSES BERHASIL</div>
    </div>
    <div style="text-align:center; font-size:12px; color:#64748b">Terima kasih telah melakukan top up di Lapak Dika</div>
</div>

<script>
    const userMail = localStorage.getItem('userEmail');
    let poll;

    function setN(v, el) { 
        document.getElementById('nom-input').value = v;
        document.querySelectorAll('.chip-nom').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    function clearChips() {
        document.querySelectorAll('.chip-nom').forEach(c => c.classList.remove('active'));
    }

    async function gasDepo() {
        const n = document.getElementById('nom-input').value;
        if(n < 2000) return alert("Minimal Rp 2.000");
        document.getElementById('view-input').style.display = 'none';
        document.getElementById('view-qr').style.display = 'block';
        document.getElementById('qr-img-cont').innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:#7c4dff; font-size:30px; padding:50px"></i>`;

        try {
            const req = await fetch(`/api/deposit?nominal=${n}&metode=QRISFAST`);
            const d = await req.json();
            if(d.success) {
                document.getElementById('qr-img-cont').innerHTML = `<img src="${d.data.qr_image}" style="width:100%; border-radius:15px">`;
                
                document.getElementById('tagihan-display').innerText = `Rp ${parseInt(d.data.nominal).toLocaleString('id-ID')}`;
                document.getElementById('fee-display').innerText = `Rp ${parseInt(d.data.fee).toLocaleString('id-ID')}`;
                document.getElementById('get-display').innerText = `Rp ${parseInt(d.data.get_balance).toLocaleString('id-ID')}`;
                
                startCheck(d.data.id);
            }
        } catch(e) { location.reload(); }
    }

    function startCheck(id) {
        poll = setInterval(async () => {
            const r = await fetch(`/api/status-deposit?id=${id}&email=${userMail}`);
            const res = await r.json();
            if(res.status === 'success') {
                clearInterval(poll);
                showSuccess(res, id);
            }
        }, 5000);
    }

    function showSuccess(res, id) {
        document.getElementById('s-time').innerText = new Date().toLocaleString('id-ID');
        document.getElementById('s-email').innerText = userMail;
        document.getElementById('s-id').innerText = id.toUpperCase();
        
        document.getElementById('s-nominal').innerText = `Rp ${parseInt(res.nominal).toLocaleString('id-ID')}`;
        document.getElementById('s-fee-struk').innerText = `- Rp ${parseInt(res.fee).toLocaleString('id-ID')}`;
        document.getElementById('s-total').innerText = `Rp ${parseInt(res.added).toLocaleString('id-ID')}`;

        setTimeout(() => {
            html2canvas(document.querySelector("#struk-canvas"), { scale: 3, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                document.body.innerHTML = `
                    <div style="text-align:center; padding:20px; animation: fadeIn 0.6s ease;">
                        <i class="fas fa-check-circle" style="font-size:60px; color:#4ade80; margin-bottom:15px"></i>
                        <h2 style="font-weight:800;">Top Up Berhasil!</h2>
                        <img src="${imgData}" style="width:100%; border-radius:25px; margin: 20px 0; box-shadow: 0 20px 40px rgba(0,0,0,0.4)">
                        <button class="btn-bayar" onclick="location.href='katalog.html'">Lanjut Belanja</button>
                    </div>
                `;
            });
        }, 800);
    }
</script>
</body>
</html>
