<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAPAK DIKA â€” OTP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --aksen: #4cc9f0; 
            --bg: #070708;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --red: #ff4d4d;
            --green: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .navbar {
            padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000;
            background: rgba(7, 7, 8, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .balance-pill {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid var(--aksen);
            padding: 8px 16px; border-radius: 100px;
            font-weight: 800; font-size: 13px; color: var(--aksen);
            display: flex; align-items: center; gap: 8px;
        }

        .container { padding: 25px; max-width: 500px; margin: 0 auto; }

        .menu-row {
            background: var(--card); border: 1px solid var(--border);
            padding: 20px; border-radius: 24px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; cursor: pointer;
        }

        .menu-info b { display: block; font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
        .menu-info span { font-size: 15px; font-weight: 700; }

        .icon-box {
            width: 45px; height: 45px; background: rgba(76, 201, 240, 0.1);
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            color: var(--aksen); font-size: 18px;
        }

        .sidebar {
            position: fixed; top: 0; left: -100%; width: 280px; height: 100%;
            background: #0d0d0f; z-index: 3000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 30px; border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .side-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2999; display: none; }
        .side-overlay.active { display: block; }

        .side-title { font-size: 10px; font-weight: 800; color: #555; margin: 25px 0 10px 10px; text-transform: uppercase; letter-spacing: 2px; display: block; }
        .side-btn { width: 100%; padding: 14px 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 15px; color: white; margin-bottom: 8px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px; font-family: inherit; }

        .full-slide { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; animation: slideUp 0.3s forwards; }
        .full-slide.active { display: flex; }
        .slide-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 20px; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .list-item { padding: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .btn-confirm { width: 100%; padding: 22px; background: var(--aksen); border: none; border-radius: 22px; color: #000; font-weight: 800; letter-spacing: 2px; cursor: pointer; margin-top: 20px; }
        .btn-confirm:disabled { opacity: 0.2; }

        .popup-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 320px; background: #16161a; border: 1px solid var(--border);
            border-radius: 30px; padding: 30px; text-align: center; z-index: 5000;
            display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .popup-msg.active { display: block; animation: pop 0.3s forwards; }

        .summary-card, .status-card { background: var(--card); border: 1px solid var(--border); border-radius: 30px; padding: 30px; display: none; }
        .summary-line { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pop { to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="side-overlay" onclick="toggleSide()"></div>
    <div class="sidebar" id="side">
        <div style="font-size: 20px; font-weight: 800; color: var(--aksen); margin-bottom: 30px;">
            <i class="fas fa-bolt"></i> LAPAK DIKA
        </div>
        <span class="side-title">Main</span>
        <button class="side-btn" onclick="location.href='katalog.html'"><i class="fas fa-home"></i> Katalog Akun</button>
        <button class="side-btn" onclick="openSide('slide-riwayat', true)"><i class="fas fa-history"></i> Riwayat OTP</button>
        <button class="side-btn" onclick="openSlide('slide-pembelian', true)"><i class="fas fa-shopping-bag"></i> Pembelian</button>
        <span class="side-title">Account</span>
        <button class="side-btn" onclick="location.href='user/katalog.html'" style="color: var(--red);"><i class="fas fa-power-off"></i> Keluar</button>
    </div>

    <nav class="navbar">
        <div style="font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-bars" onclick="toggleSide()" style="color: var(--aksen); cursor: pointer;"></i>
            OTP CENTER
        </div>
        <div class="balance-pill">
            <i class="fas fa-wallet"></i><span id="u-bal">Rp 0</span>
        </div>
    </nav>

    <div class="container">
        <div id="selection-box">
            <div class="menu-row" onclick="openSlide('slide-negara')">
                <div class="menu-info"><b>Negara</b><span id="val-negara">Pilih Wilayah</span></div>
                <div class="icon-box"><i class="fas fa-globe-asia"></i></div>
            </div>
            <div class="menu-row" id="row-layanan" style="opacity:0.2; pointer-events:none" onclick="openSlide('slide-layanan')">
                <div class="menu-info"><b>Layanan</b><span id="val-layanan">---</span></div>
                <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
            </div>
            <div class="menu-row" id="row-operator" style="opacity:0.2; pointer-events:none" onclick="openSlide('slide-operator')">
                <div class="menu-info"><b>Operator</b><span id="val-operator">---</span></div>
                <div class="icon-box"><i class="fas fa-sim-card"></i></div>
            </div>
            <button class="btn-confirm" id="btn-next" disabled onclick="showSummary()">CEK RINCIAN PESANAN</button>
        </div>

        <div class="summary-card" id="summary-box">
            <h3 style="text-align: center; margin-bottom: 25px;">KONFIRMASI BELI</h3>
            <div class="summary-line"><label>NEGARA</label><b id="sum-negara"></b></div>
            <div class="summary-line"><label>LAYANAN</label><b id="sum-layanan"></b></div>
            <div class="summary-line"><label>OPERATOR</label><b id="sum-operator"></b></div>
            <div class="summary-line"><label>ID</label><b id="sum-id"></b></div>
            <div class="summary-line"><label>HARGA</label><b id="sum-harga"></b></div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-top: 30px;">
                <button onclick="backToSelect()" style="background:rgba(255,255,255,0.05); border:none; color:white; border-radius:18px; font-weight:800; cursor:pointer;">BATAL</button>
                <button class="btn-confirm" id="btn-pay" onclick="prosesBeli()" style="margin:0">LANJUT</button>
            </div>
        </div>

        <div class="status-card" id="status-box">
            <div id="res-num" style="font-size:38px; font-weight:800; margin:15px 0; color: var(--aksen);">---</div>
            <div id="res-otp" style="font-size:55px; font-weight:800; color:var(--green); margin:10px 0; letter-spacing:8px;">------</div>
            <button class="btn-confirm" id="btn-otp" onclick="getOTP()" style="background:var(--green)">CEK SMS / OTP</button>
            <button class="btn-confirm" id="btn-cancel" onclick="cancelOrder()" style="background:transparent; border:1px solid var(--red); color:var(--red); margin-top:15px">BATALKAN (REFUND)</button>
            <button onclick="location.reload()" style="background:transparent; border:none; color:#555; margin-top:25px; font-weight:700; cursor:pointer; display:block; width:100%">MENU UTAMA</button>
        </div>
    </div>

    <div class="popup-msg" id="pop">
        <i class="fas fa-info-circle" id="pop-icon" style="font-size: 40px; color: var(--aksen); margin-bottom: 20px; display: block;"></i>
        <p id="pop-text" style="font-weight: 700; line-height: 1.5; margin-bottom: 25px;"></p>
        <button class="btn-confirm" onclick="closeNotif()" style="margin:0; padding:15px;">OKE DIKA</button>
    </div>

    <div class="full-slide" id="slide-negara">
        <div class="slide-header"><i class="fas fa-arrow-left" onclick="closeSlide()"></i><input type="text" placeholder="Cari Negara..." oninput="filterN(this.value)" style="flex:1; background:none; border:none; color:white; outline:none;"></div>
        <div class="scroll-area" id="list-negara"></div>
    </div>
    <div class="full-slide" id="slide-layanan"><div class="slide-header"><i class="fas fa-arrow-left" onclick="closeSlide()"></i><b>Pilih Layanan</b></div><div class="scroll-area" id="list-layanan"></div></div>
    <div class="full-slide" id="slide-operator"><div class="slide-header"><i class="fas fa-arrow-left" onclick="closeSlide()"></i><b>Pilih Operator</b></div><div class="scroll-area" id="list-operator"></div></div>
    <div class="full-slide" id="slide-riwayat"><div class="slide-header"><i class="fas fa-arrow-left" onclick="closeSlide()"></i><b>Riwayat OTP</b></div><div class="scroll-area" style="text-align:center; padding-top:50px; color:#555">Data riwayat tersimpan lokal.</div></div>
    <div class="full-slide" id="slide-pembelian"><div class="slide-header"><i class="fas fa-arrow-left" onclick="closeSlide()"></i><b>Riwayat Pembelian</b></div><div class="scroll-area" style="text-align:center; padding-top:50px; color:#555">Belum ada pembelian sukses.</div></div>

    <script>
        const apiKey = "58bad2b63370aef8d96140993775c47d";
        const proxy = "https://api.allorigins.win/get?url=";
        const _s = supabase.createClient('https://pmoqjgovghxibdcxpqql.supabase.co', 'sb_publishable_eXCMrrASbuEqLkNzjAMT5A_SM5GQRH6');
        const mail = localStorage.getItem('userEmail');

        let allN = [], selN = null, selL = null, selO = null, idO = null, bal = 0, conf = {};

        function toggleSide() { document.getElementById('side').classList.toggle('active'); document.querySelector('.side-overlay').classList.toggle('active'); }
        function notif(t, color = 'var(--aksen)') { 
            document.getElementById('pop-text').innerText = t; 
            document.getElementById('pop-icon').style.color = color;
            document.getElementById('pop').classList.add('active'); 
        }
        function closeNotif() { document.getElementById('pop').classList.remove('active'); }
        
        function openSlide(id, fromSide = false) { 
            if(fromSide) toggleSide(); 
            document.getElementById(id).classList.add('active'); 
        }
        
        function closeSlide() { document.querySelectorAll('.full-slide').forEach(s => s.classList.remove('active')); }

        async function loadBal() {
            const { data: u } = await _s.from('profiles').select('balance').eq('email', mail).single();
            if(u) { bal = u.balance; document.getElementById('u-bal').innerText = `Rp ${bal.toLocaleString()}`; }
        }

        async function loadN() {
            const r = await fetch(proxy + encodeURIComponent("https://api.jasaotp.id/v1/negara.php"));
            const res = JSON.parse((await r.json()).contents);
            if(res.success) { allN = res.data; renderN(allN); }
        }

        function renderN(l) { document.getElementById('list-negara').innerHTML = l.map(n => `<div class="list-item" onclick="pickN('${n.id_negara}', '${n.nama_negara}')"><b>${n.nama_negara}</b><span>ID: ${n.id_negara}</span></div>`).join(''); }
        function filterN(v) { renderN(allN.filter(n => n.nama_negara.toLowerCase().includes(v.toLowerCase()))); }

        async function pickN(id, n) {
            selN = id; conf.negara = n; closeSlide();
            document.getElementById('val-negara').innerText = n;
            document.getElementById('row-layanan').style.opacity = "1"; document.getElementById('row-layanan').style.pointerEvents = "auto";
            const r = await fetch(proxy + encodeURIComponent(`https://api.jasaotp.id/v1/layanan.php?negara=${id}`));
            const res = JSON.parse((await r.json()).contents)[id];
            let h = "";
            for(let k in res) { h += `<div class="list-item" onclick="pickL('${k}', '${res[k].layanan}', ${res[k].harga})"><b>${res[k].layanan}</b><span>Rp ${res[k].harga}</span></div>`; }
            document.getElementById('list-layanan').innerHTML = h;
        }

        function pickL(k, n, p) {
            selL = k; conf.layanan = n; conf.harga = p; closeSlide();
            document.getElementById('val-layanan').innerText = n;
            document.getElementById('row-operator').style.opacity = "1"; document.getElementById('row-operator').style.pointerEvents = "auto";
            loadOp();
        }

        async function loadOp() {
            const r = await fetch(proxy + encodeURIComponent(`https://api.jasaotp.id/v1/operator.php?negara=${selN}`));
            const res = JSON.parse((await r.json()).contents).data[selN];
            document.getElementById('list-operator').innerHTML = res.map(o => `<div class="list-item" onclick="pickO('${o}')"><b>${o.toUpperCase()}</b></div>`).join('');
        }

        function pickO(o) {
            selO = o; conf.operator = o; closeSlide();
            document.getElementById('val-operator').innerText = o.toUpperCase();
            document.getElementById('btn-next').disabled = false;
        }

        function showSummary() {
            document.getElementById('selection-box').style.display = 'none';
            document.getElementById('summary-box').style.display = 'block';
            document.getElementById('sum-negara').innerText = conf.negara;
            document.getElementById('sum-layanan').innerText = conf.layanan;
            document.getElementById('sum-operator').innerText = conf.operator.toUpperCase();
            document.getElementById('sum-id').innerText = selL;
            document.getElementById('sum-harga').innerText = "Rp " + conf.harga.toLocaleString();
        }

        function backToSelect() { document.getElementById('selection-box').style.display = 'block'; document.getElementById('summary-box').style.display = 'none'; }

        async function prosesBeli() {
            if(bal < conf.harga) return notif("Saldo lu kurang bang, isi dulu!");
            document.getElementById('btn-pay').innerText = "MENCOBA...";
            try {
                const u = encodeURIComponent(`https://api.jasaotp.id/v1/order.php?api_key=${apiKey}&negara=${selN}&layanan=${selL}&operator=${selO}`);
                const res = JSON.parse((await (await fetch(proxy + u)).json()).contents);
                if(res.success) {
                    await _s.from('profiles').update({ balance: bal - conf.harga }).eq('email', mail);
                    idO = res.data.order_id;
                    document.getElementById('summary-box').style.display = 'none';
                    document.getElementById('status-box').style.display = 'block';
                    document.getElementById('res-num').innerText = res.data.number;
                    loadBal();
                } else {
                    notif(res.message);
                    backToSelect();
                    document.getElementById('btn-pay').innerText = "LANJUT";
                }
            } catch (e) { notif("API Error!"); document.getElementById('btn-pay').innerText = "LANJUT"; }
        }

        async function getOTP() {
            const btn = document.getElementById('btn-otp');
            btn.innerText = "MENGECEK...";
            try {
                const r = await fetch(proxy + encodeURIComponent(`https://api.jasaotp.id/v1/sms.php?api_key=${apiKey}&id=${idO}`));
                const res = JSON.parse((await r.json()).contents);
                if(res.success && res.data.otp) { 
                    document.getElementById('res-otp').innerText = res.data.otp;
                    navigator.clipboard.writeText(res.data.otp);
                    notif(`OTP DITEMUKAN: ${res.data.otp} (Sudah di-Copy!)`, 'var(--green)');
                    btn.innerText = "OTP MASUK!";
                    btn.style.background = "var(--green)";
                    document.getElementById('btn-cancel').style.display = "none";
                } else { 
                    notif("Belum ada SMS masuk bang."); 
                    btn.innerText = "CEK SMS / OTP";
                }
            } catch (e) { btn.innerText = "CEK SMS / OTP"; }
        }

        async function cancelOrder() {
            if(!confirm("Batalin? Duit otomatis balik ke saldo lu bang.")) return;
            const btn = document.getElementById('btn-cancel');
            btn.innerText = "BATALIN...";
            try {
                const r = await fetch(proxy + encodeURIComponent(`https://api.jasaotp.id/v1/cancel.php?api_key=${apiKey}&id=${idO}`));
                const res = JSON.parse((await r.json()).contents);
                if(res.success) {
                    const { data: current } = await _s.from('profiles').select('balance').eq('email', mail).single();
                    await _s.from('profiles').update({ balance: current.balance + conf.harga }).eq('email', mail);
                    notif("REFUND BERHASIL!", 'var(--green)');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    notif("Gagal Batal: " + res.message, 'var(--red)');
                    btn.innerText = "BATALKAN (REFUND)";
                }
            } catch (e) { btn.innerText = "BATALKAN (REFUND)"; }
        }

        loadBal(); loadN();
    </script>
</body>
</html>
